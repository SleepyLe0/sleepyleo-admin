FROM oven/bun:1-alpine
RUN apk add --no-cache libc6-compat
WORKDIR /app

COPY package.json bun.lock* ./
RUN bun install

# Generate Prisma client
COPY prisma ./prisma
ENV DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy"
RUN bunx prisma generate

# Install cloudflared for SSH tunneling
RUN apk add --no-cache wget \
    && wget --tries=5 --timeout=30 -q -O /usr/local/bin/cloudflared \
       https://github.com/cloudflare/cloudflared/releases/download/2024.12.2/cloudflared-linux-amd64 \
    && chmod +x /usr/local/bin/cloudflared \
    && apk del wget \
    || echo "Warning: cloudflared installation failed"

EXPOSE 3000
CMD ["bunx", "next", "dev", "--hostname", "0.0.0.0"]
